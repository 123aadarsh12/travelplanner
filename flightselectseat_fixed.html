<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Your Seat</title>
    <!-- ...existing styles... -->
</head>
<body>
    <!-- ...existing HTML structure... -->
    <script>
        // Global state object to prevent variable redeclarations
        const state = {
            SEAT_PRICE: 850.00,
            currentSeatSegment: 0,
            seatmapTravelers: 1,
            seatmapCurrentTraveler: 0,
            seatmapSelectedSeats: [],
            seatSelections: [[], []],
            priceCalculation: {
                ticketBase: 0,
                seatCharges: 0,
                totalPrice: 0
            },
            airportNames: {
                DEL: "New Delhi",
                BOM: "Mumbai",
                BLR: "Bangalore", 
                MAA: "Chennai",
                CCU: "Kolkata"
            }
        };

        // Initialize state from session storage
        function initializeState() {
            const adults = parseInt(sessionStorage.getItem("bookingAdults") || "1", 10);
            const children = parseInt(sessionStorage.getItem("bookingChildren") || "0", 10);
            state.travelerCount = adults + children;
            state.bookingDetails = {
                adults,
                children,
                from: sessionStorage.getItem("bookingFrom") || "DEL",
                to: sessionStorage.getItem("bookingTo") || "BOM",
                journeyType: sessionStorage.getItem("bookingJourneyType") || "one-way",
                departure: sessionStorage.getItem("bookingDeparture") || "",
                returnDate: sessionStorage.getItem("bookingReturn") || "",
                fare: parseFloat(sessionStorage.getItem("bookingFare") || "0"),
                selectedFlights: JSON.parse(sessionStorage.getItem("selectedFlights") || "[]")
            };

            // Initialize price calculation
            state.priceCalculation.ticketBase = state.bookingDetails.fare;
            state.priceCalculation.totalPrice = state.bookingDetails.fare;
            
            // Try to restore seat selections
            try {
                const savedSeats = sessionStorage.getItem("seatSelections");
                if (savedSeats) {
                    state.seatSelections = JSON.parse(savedSeats);
                    // Calculate seat charges for saved seats
                    state.priceCalculation.seatCharges = calculateSeatCharges(state.seatSelections);
                    state.priceCalculation.totalPrice = state.priceCalculation.ticketBase + state.priceCalculation.seatCharges;
                } else {
                    state.seatSelections = [
                        Array(state.travelerCount).fill(""),
                        Array(state.travelerCount).fill("")
                    ];
                }
            } catch (e) {
                console.error("Error restoring seat selections:", e);
                state.seatSelections = [
                    Array(state.travelerCount).fill(""),
                    Array(state.travelerCount).fill("")
                ];
            }

            sessionStorage.setItem("priceCalculation", JSON.stringify(state.priceCalculation));
            return state.bookingDetails;
        }

        // Utility functions
        function calculateSeatCharges(selectedSeats) {
            return selectedSeats.reduce((total, seats) => {
                if (seats && Array.isArray(seats)) {
                    return total + (seats.filter(s => s).length * state.SEAT_PRICE);
                }
                return total;
            }, 0);
        }

        function formatDate(dateStr) {
            if (!dateStr) return "-";
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;
            return d.toLocaleDateString("en-US", {
                weekday: "short",
                month: "short",
                day: "numeric",
            });
        }

        function updatePriceDisplay() {
            const baseFare = state.priceCalculation.ticketBase;
            const seatCharges = state.priceCalculation.seatCharges;
            const total = state.priceCalculation.totalPrice;

            let priceHtml = `
                <div class="price-row">
                    <span>Ticket fare</span>
                    <span>INR${baseFare.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                </div>`;
            
            if (seatCharges > 0) {
                priceHtml += `
                <div class="price-row" style="color:#0071c2">
                    <span>Seat selection</span>
                    <span>INR${seatCharges.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                </div>`;
            }
            
            document.getElementById("price-row").innerHTML = priceHtml;
            document.getElementById("total-row").innerHTML = 
                `<span>Total</span><span>INR${total.toLocaleString(undefined, {minimumFractionDigits:2})}</span>`;
        }

        function renderSeatMap(travelers, selectedSeats, currentTraveler) {
            // Implementation remains the same
        }

        function renderTravelerList(travelers, selectedSeats, currentTraveler) {
            // Implementation remains the same
        }

        // Main initialization
        window.addEventListener("DOMContentLoaded", function () {
            try {
                const booking = initializeState();
                
                // Validate required data
                if (!booking.from || !booking.to || !booking.selectedFlights || booking.selectedFlights.length === 0) {
                    throw new Error("Missing flight booking details. Please start over.");
                }

                // Update UI elements
                const fromName = state.airportNames[booking.from] || booking.from;
                const toName = state.airportNames[booking.to] || booking.to;

                // Update trip summary
                document.getElementById("trip-summary").innerHTML = `
                    ${booking.journeyType === "round-trip" ? "Round-trip" : "One-way"}
                    &nbsp;•&nbsp; ${state.travelerCount} traveler${state.travelerCount > 1 ? "s" : ""}
                    &nbsp;•&nbsp; ${formatDate(booking.departure)}${booking.journeyType === "round-trip" && booking.returnDate ? " - " + formatDate(booking.returnDate) : ""}
                `;

                document.getElementById("route-title").textContent = `${fromName} to ${toName}`;

                // Update flight segments
                const segments = document.querySelectorAll('.flight-segment');
                segments.forEach((seg, idx) => {
                    const flight = booking.selectedFlights[idx];
                    const savedSeats = state.seatSelections[idx] || [];
                    
                    seg.querySelector('.flight-segment-title').textContent = 
                        idx === 0 ? `${fromName} - ${toName}` : `${toName} - ${fromName}`;
                    
                    seg.querySelector('.flight-segment-details').textContent =
                        flight ? `${flight.duration || '2h 15m'} · ${flight.airlineName}${flight.isCodeshare ? ' (Operated by ' + flight.operatedBy + ')' : ''}`
                        : 'Flight details not available';
                    
                    if (savedSeats.some(s => s)) {
                        let seatText = savedSeats.map((s, i) =>
                            `<div style="margin-bottom:6px;">
                                <span style="color:#0071c2;">✓</span> Traveler ${i + 1}: 
                                ${s ? '<b>Seat ' + s + '</b>' : '<span style="color:#888;">No seat selected</span>'}
                            </div>`).join('');
                        seg.querySelector('.no-seats').innerHTML = seatText;
                        seg.querySelector('.select-seats-link').style.display = 'none';
                    } else {
                        seg.querySelector('.no-seats').textContent = 'No seats selected';
                        seg.querySelector('.select-seats-link').textContent = 
                            `Select seats from INR${state.SEAT_PRICE.toLocaleString(undefined, {minimumFractionDigits:2})}`;
                    }

                    // Show/hide segments based on journey type
                    seg.style.display = idx < (booking.journeyType === "round-trip" ? 2 : 1) ? '' : 'none';
                });

                // Update travelers and price display
                document.getElementById("flight-travelers").textContent =
                    `Flight (${state.travelerCount} traveler${state.travelerCount > 1 ? "s" : ""})`;
                updatePriceDisplay();

                // Event Handlers
                document.querySelectorAll('.select-seats-link').forEach((el, segIdx) => {
                    el.addEventListener('click', function () {
                        state.currentSeatSegment = segIdx;
                        state.seatmapCurrentTraveler = 0;
                        state.seatmapSelectedSeats = state.seatSelections[segIdx].slice() || Array(state.travelerCount).fill("");
                        
                        document.getElementById('seatmap-modal-title').textContent =
                            segIdx === 0 ? `Select seats for ${fromName} - ${toName}` :
                            `Select seats for ${toName} - ${fromName}`;
                        
                        document.getElementById('seatmap-travelers').innerHTML = renderTravelerList(
                            state.travelerCount, state.seatmapSelectedSeats, state.seatmapCurrentTraveler);
                        document.getElementById('seatmap-grid').innerHTML = renderSeatMap(
                            state.travelerCount, state.seatmapSelectedSeats, state.seatmapCurrentTraveler);
                        document.getElementById('seatmap-modal').style.display = 'flex';
                    });
                });

                // Event handlers for seat selection and modal...
                // Rest of the code remains the same but uses state.* instead of local variables

            } catch (error) {
                console.error("Initialization error:", error);
                document.querySelector(".main-card").innerHTML = `
                    <div style="text-align:center;padding:32px;">
                        <div style="color:#e31c23;margin-bottom:16px;">⚠️ ${error.message}</div>
                        <div style="color:#666;margin-bottom:24px;">Please start over from the flight search page.</div>
                        <button onclick="window.location.href='flight-index1.html'" 
                                style="background:#0071c2;color:#fff;border:none;border-radius:7px;padding:10px 32px;font-size:1.1em;font-weight:500;cursor:pointer;">
                            Go to Flight Search
                        </button>
                    </div>`;
            }
        });
    </script>
</body>
</html>
