<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boarding Pass</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f0f0f0;
            padding: 30px;
            margin: 0;
        }

        .boarding-pass-modern {
            width: 1200px;
            max-width: 98vw;
            min-width: 700px;
            height: auto;
            min-height: 340px;
            background: #fff;
            border-radius: 32px;
            box-shadow: 0 8px 32px #0002;
            margin: 32px auto 0 auto;
            display: flex;
            overflow: visible;
            position: relative;
        }

        .bp-left,
        .bp-right {
            min-width: 0;
        }

        .bp-left {
            width: 65%;
            background: #2a3b8f;
            color: #fff;
            padding: 36px 32px 36px 48px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            border-top-left-radius: 32px;
            border-bottom-left-radius: 32px;
        }

        .bp-left .bp-title {
            font-size: 1.3em;
            font-weight: 700;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .bp-left .bp-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 1.15em;
            flex-wrap: wrap;
            word-break: break-word;
        }

        .bp-left .bp-label {
            width: 140px;
            min-width: 110px;
            color: #b3c6ff;
            font-weight: 500;
            flex-shrink: 0;
            font-size: 1em;
        }

        .bp-left .bp-value {
            font-weight: 600;
            color: #fff;
            flex: 1;
            min-width: 0;
        }

        .bp-left .bp-boarding-time {
            font-size: 2.1em;
            color: #ff2a2a;
            font-weight: 700;
            margin-top: 10px;
        }

        .bp-left .bp-gate-warning {
            color: #ff2a2a;
            font-size: 1em;
            margin-top: 8px;
            font-weight: 500;
        }

        .bp-barcode {
            width: 260px;
            height: 72px;
            background: #fff;
            margin: 18px 0 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bp-divider {
            width: 8px;
            background: repeating-linear-gradient(to bottom, #fff, #fff 18px, transparent 18px, transparent 36px);
            border-radius: 0 12px 12px 0;
        }

        .bp-right {
            width: 35%;
            background: #fff;
            color: #2a3b8f;
            padding: 36px 32px 36px 32px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            border-top-right-radius: 32px;
            border-bottom-right-radius: 32px;
        }

        .bp-right .bp-title {
            font-size: 1.3em;
            font-weight: 700;
            letter-spacing: 2px;
            margin-bottom: 18px;
            color: #2a3b8f;
        }

        .bp-right .bp-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .bp-right .bp-label {
            width: 110px;
            min-width: 90px;
            color: #7a8cc2;
            font-weight: 500;
        }

        .bp-right .bp-value {
            color: #2a3b8f;
        }

        .bp-right .bp-seat-box {
            border: 2px solid #2a3b8f;
            border-radius: 8px;
            padding: 8px 18px;
            font-size: 1.2em;
            font-weight: 700;
            color: #2a3b8f;
            background: #f5f8ff;
            margin-top: 12px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .bp-right .bp-gate-box {
            border: 2px solid #ff2a2a;
            border-radius: 8px;
            padding: 8px 18px;
            font-size: 1.2em;
            font-weight: 700;
            color: #ff2a2a;
            background: #fff0f0;
            margin: 0 10px 0 0;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .bp-right .bp-mid-value {
            font-weight: 600;
            color: #fff;
            background: #2a3b8f;
            border-radius: 6px;
            padding: 6px 14px;
            margin: 0 10px 0 0;
            min-width: 60px;
            text-align: center;
            display: inline-block;
        }

        .bp-right .bp-nice-trip {
            color: #2a3b8f;
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 18px;
            text-align: right;
        }

        @media (max-width: 1000px) {
            .boarding-pass-modern {
                width: 98vw;
                min-width: 0;
                padding: 0;
            }

            .bp-left,
            .bp-right {
                padding: 18px 8vw 18px 8vw;
            }
        }

        #passes-container {
            width: 100vw;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-bottom: 40px;
            overflow-x: visible;
        }

        .boarding-pass-modern.physical-size {
            width: 10.5in;
            height: 3.25in;
            min-width: unset;
            min-height: unset;
            max-width: unset;
            box-sizing: border-box;
        }

        @media print {
            body {
                background: #fff;
            }

            .boarding-pass-modern {
                box-shadow: none;
                margin: 0 auto;
            }
        }

        #download-btn {
            display: block;
            margin: 24px auto 0 auto;
            padding: 12px 32px;
            background: #2a3b8f;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        #download-btn:hover {
            background: #1a265c;
        }

        .bp-details-columns {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 10px;
            background: #22306b;
            border-radius: 18px;
            padding: 14px 18px;
            margin: 18px 0 10px 0;
            box-shadow: 0 2px 8px #0001;
        }

        .bp-col {
            width: 48%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bp-details-columns .bp-label {
            width: auto;
            min-width: 0;
            margin-right: 10px;
            color: #b3c6ff;
            font-weight: 500;
            font-size: 1em;
        }

        .bp-details-columns .bp-mid-value,
        .bp-details-columns .bp-gate-box {
            margin-left: 8px;
            margin-bottom: 6px;
            min-width: 60px;
            font-size: 1.08em;
            display: inline-block;
        }

        .bp-details-columns .bp-col>div {
            margin-bottom: 8px;
        }

        @media (max-width: 700px) {
            .boarding-pass-modern {
                flex-direction: column;
                border-radius: 18px;
                min-width: 0;
                width: 98vw;
            }

            .bp-left,
            .bp-right {
                border-radius: 18px;
                padding: 18px 8vw 18px 8vw;
            }

            .bp-details-columns {
                flex-direction: column;
                gap: 18px;
            }

            .bp-col {
                width: 100%;
            }
        }

        .bp-middle-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #22306b;
            border-radius: 18px;
            padding: 18px 28px;
            margin: 24px auto 18px auto;
            box-shadow: 0 2px 8px #0001;
            width: 70%;
        }

        .bp-middle-details .bp-row {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }

        .bp-middle-details .bp-label {
            min-width: 110px;
            text-align: right;
            margin-right: 12px;
            color: #b3c6ff;
            font-weight: 500;
        }

        .bp-middle-details .bp-mid-value,
        .bp-middle-details .bp-gate-box {
            margin-left: 8px;
            min-width: 60px;
            font-size: 1.08em;
            display: inline-block;
        }

        .bp-middle-details .bp-gate-box {
            border: 2px solid #ff2a2a;
            border-radius: 8px;
            padding: 8px 18px;
            font-size: 1.2em;
            font-weight: 700;
            color: #ff2a2a;
            background: #fff0f0;
            margin-left: 8px;
        }

        .bp-inline-details {
            display: flex;
            flex-direction: column;
            margin-left: 10px;
        }

        .bp-inline-row {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 1em;
        }

        .bp-inline-row .bp-label {
            width: 80px;
            color: #b3c6ff;
            font-weight: 500;
            margin-right: 6px;
        }

        .bp-inline-row .bp-mid-value {
            color: #fff;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <button id="download-btn">Download Boarding Pass (PDF)</button>
    <div id="passes-container"></div>
    <script>
        const container = document.getElementById('passes-container');
        let travelers = [];
        let seatSelections = [];
        let flightNumbers = [];
        let departureTimes = [];
        let arrivalTimes = [];
        let from = sessionStorage.getItem('bookingFrom') || '-';
        let to = sessionStorage.getItem('bookingTo') || '-';
        let date = sessionStorage.getItem('bookingDeparture') || '-';
        let returnDate = sessionStorage.getItem('bookingReturn') || '';
        let journeyType = sessionStorage.getItem('bookingJourneyType') || 'one-way';
        let gate = '47'; // Example gate
        try {
            const stored = sessionStorage.getItem('travelers');
            travelers = stored ? JSON.parse(stored) : [];
        } catch (e) {
            travelers = [];
        }
        try {
            seatSelections = JSON.parse(sessionStorage.getItem('seatSelections') || '[]');
        } catch (e) {
            seatSelections = [];
        }
        try {
            flightNumbers = JSON.parse(sessionStorage.getItem('flightNumbers') || '[]');
        } catch (e) {
            flightNumbers = [];
        }
        try {
            departureTimes = JSON.parse(sessionStorage.getItem('flightDepartureTimes') || '[]');
        } catch (e) {
            departureTimes = [];
        }
        try {
            arrivalTimes = JSON.parse(sessionStorage.getItem('flightArrivalTimes') || '[]');
        } catch (e) {
            arrivalTimes = [];
        }

        function getTravelerDetails(idx, seg) {
            let seat = (seatSelections[seg] && seatSelections[seg][idx]) ? seatSelections[seg][idx] : '--';
            let flight = (flightNumbers[seg]) ? flightNumbers[seg] : '--';
            let depTime = (departureTimes[seg]) ? departureTimes[seg] : '--';
            let arrTime = (arrivalTimes[seg]) ? arrivalTimes[seg] : '--';
            return {
                seat,
                flight,
                depTime,
                arrTime
            };
        }
        if (travelers.length === 0) {
            container.innerHTML = "<p>No boarding pass data found. Please return to the booking page.</p>";
        } else {
            let segments = journeyType === 'round-trip' ? 2 : 1;
            for (let seg = 0; seg < segments; seg++) {
                for (let i = 0; i < travelers.length; i++) {
                    const t = travelers[i];
                    const {
                        seat,
                        flight,
                        depTime,
                        arrTime
                    } = getTravelerDetails(i, seg);
                    const passDate = seg === 0 ? date : returnDate;
                    const passFrom = seg === 0 ? from : to;
                    const passTo = seg === 0 ? to : from;
                    container.innerHTML += `
            <div class="boarding-pass-modern">
                <div class="bp-left">
                    <div class="bp-title">BOARDING PASS &nbsp; <span style='font-size:0.8em;font-weight:400;'>ECONOMY</span></div>
                    <div class="bp-row" style="align-items: flex-start;">
                        <span class="bp-label">NAME OF PASSENGER</span>
                        <span class="bp-value">${t.name || 'Passenger'}</span>
                        <div class="bp-inline-details">
                            <div class="bp-inline-row"><span class="bp-label">FROM</span><span class="bp-mid-value">${passFrom}</span></div>
                            <div class="bp-inline-row"><span class="bp-label">TO</span><span class="bp-mid-value">${passTo}</span></div>
                            <div class="bp-inline-row"><span class="bp-label">BOARDING</span><span class="bp-mid-value">${depTime || '--'}</span></div>
                            <div class="bp-inline-row"><span class="bp-label">ARRIVAL</span><span class="bp-mid-value">${arrTime}</span></div>
                            <div class="bp-inline-row"><span class="bp-label">GATE</span><span class="bp-gate-box">${gate}</span></div>
                        </div>
                    </div>
                    <div class="bp-row"><span class="bp-label">FLIGHT</span><span class="bp-value">${flight}</span></div>
                    <div class="bp-row"><span class="bp-label">DATE</span><span class="bp-value">${passDate}</span></div>
                    <div class="bp-row"><span class="bp-label">SEAT</span><span class="bp-seat-box">${seat}</span></div>
                    <div class="bp-row"><span class="bp-label">ETKT</span><span class="bp-mid-value">5552115239450</span></div>
                        <div class="bp-row"><span class="bp-label">TRAVELER #</span><span class="bp-mid-value">${i + 1}</span></div>
                        <div class="bp-row"><span class="bp-label">SEGMENT</span><span class="bp-mid-value">${seg + 1}${segments > 1 ? ' of ' + segments : ''}</span></div>
                    <div class="bp-gate-warning">GATE CLOSES 40 MINUTES BEFORE DEPARTURE</div>
                    <div class="bp-barcode"><svg id="barcode-${seg}-${i}"></svg></div>
                </div>
                <div class="bp-divider"></div>
                <div class="bp-right">
                    <div class="bp-title">BOARDING PASS &nbsp; <span style='font-size:0.8em;font-weight:400;'>ECONOMY</span></div>
                    <div class="bp-row"><span class="bp-label">NAME</span><span class="bp-value">${t.name || 'Passenger'}</span></div>
                    <div class="bp-row"><span class="bp-label">FROM</span><span class="bp-value">${passFrom}</span></div>
                    <div class="bp-row"><span class="bp-label">TO</span><span class="bp-value">${passTo}</span></div>
                    <div class="bp-row"><span class="bp-label">FLIGHT</span><span class="bp-value">${flight}</span></div>
                    <div class="bp-row"><span class="bp-label">DATE</span><span class="bp-value">${passDate}</span></div>
                    <div class="bp-row"><span class="bp-label">GATE</span><span class="bp-value">${gate}</span></div>
                    <div class="bp-row"><span class="bp-label">SEAT</span><span class="bp-seat-box">${seat}</span></div>
                    <div class="bp-nice-trip">HAVE A NICE TRIP!</div>
                </div>
            </div>`;
                }
            }
            // After rendering, generate barcodes for each pass
            for (let seg = 0; seg < segments; seg++) {
                for (let i = 0; i < travelers.length; i++) {
                    const t = travelers[i];
                    const {
                        seat,
                        flight,
                        depTime,
                        arrTime
                    } = getTravelerDetails(i, seg);
                    const passDate = seg === 0 ? date : returnDate;
                    const passFrom = seg === 0 ? from : to;
                    const passTo = seg === 0 ? to : from;
                    // Compose barcode data string (CSV style)
                    const barcodeData = [
                        t.name || '',
                        flight,
                        seat,
                        passFrom,
                        passTo,
                        passDate,
                        gate,
                        depTime,
                        arrTime
                    ].join('|');
                    JsBarcode(`#barcode-${seg}-${i}`,
                        barcodeData, {
                            format: "CODE128",
                            width: 3.2, // increased bar width
                            height: 70, // increased barcode height
                            displayValue: false,
                            margin: 0
                        }
                    );
                }
            }
            // Set physical size for all passes
            document.querySelectorAll('.boarding-pass-modern').forEach(el => {
                el.classList.add('physical-size');
            });
        }
        // PDF download logic
        document.getElementById('download-btn').addEventListener('click', function () {
            // Load html2pdf.js dynamically if not present
            if (!window.html2pdf) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                script.onload = generatePDF;
                document.body.appendChild(script);
            } else {
                generatePDF();
            }

            function generatePDF() {
                const passes = document.getElementById('passes-container');
                // Temporarily set all passes to larger PDF size for export
                document.querySelectorAll('.boarding-pass-modern').forEach(el => {
                    el.classList.add('physical-size');
                });
                const opt = {
                    margin: 0,
                    filename: 'boarding-pass.pdf',
                    image: {
                        type: 'jpeg',
                        quality: 0.98
                    },
                    html2canvas: {
                        scale: 3,
                        useCORS: true,
                        windowWidth: 1200
                    },
                    jsPDF: {
                        unit: 'in',
                        format: [10.5, 3.25],
                        orientation: 'landscape'
                    }
                };
                html2pdf().set(opt).from(passes).save().then(() => {
                    // Restore normal size after export
                    document.querySelectorAll('.boarding-pass-modern').forEach(el => {
                        el.classList.remove('physical-size');
                    });
                });
            }
        });
    </script>


</body>

</html>