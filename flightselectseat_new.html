<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Your Seat</title>
    <style>
        /* Existing styles section */
    </style>
</head>
<body>
    <div class="progress-bar">
        <!-- Existing progress bar section -->
    </div>
    <div class="container">
        <div class="trip-summary" id="trip-summary"></div>
        <div class="section-title" id="route-title"></div>
        <div class="flex-row">
            <!-- Existing content -->
        </div>
    </div>
    <!-- Seat Map Modal -->
    <div id="seatmap-modal">
        <!-- Existing modal content -->
    </div>

    <script>
        // Global state to avoid variable redeclaration issues
        const state = {
            SEAT_PRICE: 850.00,
            currentSeatSegment: 0,
            seatmapTravelers: 1,
            seatmapCurrentTraveler: 0,
            seatmapSelectedSeats: [],
            seatSelections: [[], []],
            priceCalculation: {
                ticketBase: 0,
                seatCharges: 0,
                totalPrice: 0
            },
            airportNames: {
                DEL: "New Delhi",
                BOM: "Mumbai",
                BLR: "Bangalore", 
                MAA: "Chennai",
                CCU: "Kolkata"
            }
        };

        function formatDate(dateStr) {
            if (!dateStr) return "-";
            const d = new Date(dateStr);
            if (isNaN(d)) return dateStr;
            return d.toLocaleDateString("en-US", {
                weekday: "short",
                month: "short",
                day: "numeric",
            });
        }

        function updatePriceDisplay() {
            const priceCalc = JSON.parse(sessionStorage.getItem("priceCalculation") || "{}");
            const baseFare = priceCalc.ticketBase || state.priceCalculation.ticketBase;
            const seatCharges = priceCalc.seatCharges || 0;
            const total = priceCalc.totalPrice || baseFare;

            let priceHtml = `
                <div class="price-row">
                    <span>Ticket fare</span>
                    <span>INR${baseFare.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                </div>`;
            
            if (seatCharges > 0) {
                priceHtml += `
                <div class="price-row" style="color:#0071c2">
                    <span>Seat selection</span>
                    <span>INR${seatCharges.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                </div>`;
            }
            
            document.getElementById("price-row").innerHTML = priceHtml;
            document.getElementById("total-row").innerHTML = 
                `<span>Total</span><span>INR${total.toLocaleString(undefined, {minimumFractionDigits:2})}</span>`;
        }

        window.addEventListener("DOMContentLoaded", function () {
            try {
                // Load booking data
                const adults = parseInt(sessionStorage.getItem("bookingAdults") || "1", 10);
                const children = parseInt(sessionStorage.getItem("bookingChildren") || "0", 10);
                const travelerCount = adults + children;
                const from = sessionStorage.getItem("bookingFrom") || "DEL";
                const to = sessionStorage.getItem("bookingTo") || "BOM";
                const journeyType = sessionStorage.getItem("bookingJourneyType") || "one-way";
                const departure = sessionStorage.getItem("bookingDeparture") || "";
                const returnDate = sessionStorage.getItem("bookingReturn") || "";
                const fare = parseFloat(sessionStorage.getItem("bookingFare") || "0");
                const selectedFlights = JSON.parse(sessionStorage.getItem("selectedFlights") || "[]");

                // Validate required data
                if (!from || !to || !selectedFlights || selectedFlights.length === 0) {
                    throw new Error("Missing flight booking details. Please start over.");
                }

                // Update state
                state.priceCalculation.ticketBase = fare;
                state.priceCalculation.totalPrice = fare;
                state.seatmapTravelers = travelerCount;

                // Try to restore seat selections
                try {
                    const savedSeats = sessionStorage.getItem("seatSelections");
                    if (savedSeats) {
                        state.seatSelections = JSON.parse(savedSeats);
                        state.seatSelections.forEach(segmentSeats => {
                            if (segmentSeats && segmentSeats.filter(s => s).length > 0) {
                                state.priceCalculation.seatCharges += segmentSeats.filter(s => s).length * state.SEAT_PRICE;
                            }
                        });
                    } else {
                        state.seatSelections = [Array(travelerCount).fill(""), Array(travelerCount).fill("")];
                    }
                } catch (e) {
                    console.error("Error restoring seat selections:", e);
                    state.seatSelections = [Array(travelerCount).fill(""), Array(travelerCount).fill("")];
                }

                // Update prices
                state.priceCalculation.totalPrice = state.priceCalculation.ticketBase + state.priceCalculation.seatCharges;
                sessionStorage.setItem("priceCalculation", JSON.stringify(state.priceCalculation));

                // Update UI
                const fromName = state.airportNames[from] || from;
                const toName = state.airportNames[to] || to;

                // Update trip summary
                document.getElementById("trip-summary").innerHTML = `
                    ${journeyType === "round-trip" ? "Round-trip" : "One-way"}
                    &nbsp;•&nbsp; ${travelerCount} traveler${travelerCount > 1 ? "s" : ""}
                    &nbsp;•&nbsp; ${formatDate(departure)}${journeyType === "round-trip" && returnDate ? " - " + formatDate(returnDate) : ""}
                `;

                // Update route title
                document.getElementById("route-title").textContent = `${fromName} to ${toName}`;

                // Update flight segments
                const segments = document.querySelectorAll('.flight-segment');
                segments.forEach((seg, idx) => {
                    const flight = selectedFlights[idx];
                    const savedSeats = state.seatSelections[idx] || [];
                    
                    seg.querySelector('.flight-segment-title').textContent = 
                        idx === 0 ? `${fromName} - ${toName}` : `${toName} - ${fromName}`;
                    
                    seg.querySelector('.flight-segment-details').textContent =
                        flight ? `${flight.duration || '2h 15m'} · ${flight.airlineName}${flight.isCodeshare ? ' (Operated by ' + flight.operatedBy + ')' : ''}`
                        : 'Flight details not available';
                    
                    if (savedSeats.some(s => s)) {
                        let seatText = savedSeats.map((s, i) =>
                            `<div style="margin-bottom:6px;">
                                <span style="color:#0071c2;">✓</span> Traveler ${i + 1}: 
                                ${s ? '<b>Seat ' + s + '</b>' : '<span style="color:#888;">No seat selected</span>'}
                            </div>`).join('');
                        seg.querySelector('.no-seats').innerHTML = seatText;
                        seg.querySelector('.select-seats-link').style.display = 'none';
                    } else {
                        seg.querySelector('.no-seats').textContent = 'No seats selected';
                        seg.querySelector('.select-seats-link').textContent = `Select seats from INR${state.SEAT_PRICE.toLocaleString(undefined, {minimumFractionDigits:2})}`;
                    }

                    // Show/hide segments based on journey type
                    seg.style.display = idx < (journeyType === "round-trip" ? 2 : 1) ? '' : 'none';
                });

                // Update travelers and price display
                document.getElementById("flight-travelers").textContent =
                    `Flight (${travelerCount} traveler${travelerCount > 1 ? "s" : ""})`;
                updatePriceDisplay();

                // Event Handlers
                document.querySelectorAll('.select-seats-link').forEach((el, segIdx) => {
                    el.addEventListener('click', function () {
                        state.currentSeatSegment = segIdx;
                        state.seatmapCurrentTraveler = 0;
                        state.seatmapSelectedSeats = state.seatSelections[segIdx].slice() || Array(travelerCount).fill("");
                        
                        document.getElementById('seatmap-modal-title').textContent =
                            segIdx === 0 ? `Select seats for ${fromName} - ${toName}` :
                            `Select seats for ${toName} - ${fromName}`;
                        
                        document.getElementById('seatmap-travelers').innerHTML = renderTravelerList(
                            travelerCount, state.seatmapSelectedSeats, state.seatmapCurrentTraveler);
                        document.getElementById('seatmap-grid').innerHTML = renderSeatMap(
                            travelerCount, state.seatmapSelectedSeats, state.seatmapCurrentTraveler);
                        document.getElementById('seatmap-modal').style.display = 'flex';
                    });
                });

                // Seat selection handler
                document.getElementById('seatmap-grid').addEventListener('click', async function (e) {
                    if (!e.target.classList.contains('seat-btn')) return;
                    
                    try {
                        e.target.style.opacity = '0.5';
                        e.target.disabled = true;

                        const seat = e.target.getAttribute('data-seat');
                        if (state.seatmapSelectedSeats.includes(seat)) {
                            throw new Error("This seat is already selected.");
                        }

                        await new Promise(resolve => setTimeout(resolve, 300));

                        state.seatmapSelectedSeats[state.seatmapCurrentTraveler] = seat;
                        if (state.seatmapCurrentTraveler < travelerCount - 1) {
                            state.seatmapCurrentTraveler++;
                        }

                        document.getElementById('seatmap-travelers').innerHTML = renderTravelerList(
                            travelerCount, state.seatmapSelectedSeats, state.seatmapCurrentTraveler);
                        document.getElementById('seatmap-grid').innerHTML = renderSeatMap(
                            travelerCount, state.seatmapSelectedSeats, state.seatmapCurrentTraveler);
                    } catch (error) {
                        alert(error.message || "Failed to select seat. Please try again.");
                    } finally {
                        if (e.target && e.target.style) {
                            e.target.style.opacity = '1';
                            e.target.disabled = false;
                        }
                    }
                });

                // Done button handler
                document.getElementById('seatmap-done-btn').onclick = function () {
                    state.seatSelections[state.currentSeatSegment] = state.seatmapSelectedSeats.slice();
                    
                    // Recalculate total seat charges
                    state.priceCalculation.seatCharges = state.seatSelections.reduce((total, seats) => {
                        return total + (seats.filter(s => s).length * state.SEAT_PRICE);
                    }, 0);
                    
                    state.priceCalculation.totalPrice = state.priceCalculation.ticketBase + state.priceCalculation.seatCharges;
                    
                    // Save to session storage
                    sessionStorage.setItem("seatSelections", JSON.stringify(state.seatSelections));
                    sessionStorage.setItem("priceCalculation", JSON.stringify(state.priceCalculation));
                    
                    // Update UI
                    const segments = document.querySelectorAll('.flight-segment');
                    let seatText = state.seatmapSelectedSeats.map((s, i) =>
                        `<div style="margin-bottom:6px;">
                            <span style="color:#0071c2;">✓</span> Traveler ${i + 1}: 
                            ${s ? '<b>Seat ' + s + '</b>' : '<span style="color:#888;">No seat selected</span>'}
                        </div>`).join('');
                    
                    segments[state.currentSeatSegment].querySelector('.no-seats').innerHTML = seatText;
                    segments[state.currentSeatSegment].querySelector('.select-seats-link').style.display = 'none';
                    
                    updatePriceDisplay();
                    document.getElementById('seatmap-modal').style.display = 'none';
                };

                // Next button validation
                document.querySelector('.btn-next').addEventListener('click', function(e) {
                    this.innerHTML = '<span style="opacity:0.7">Validating...</span>';
                    this.disabled = true;

                    try {
                        const requiredSegments = journeyType === "round-trip" ? 2 : 1;
                        for (let seg = 0; seg < requiredSegments; seg++) {
                            const seats = state.seatSelections[seg] || [];
                            if (!Array.isArray(seats) || seats.length !== travelerCount || seats.some(s => !s)) {
                                throw new Error("Please select a seat for every traveler on all flight segments before continuing.");
                            }
                        }
                        window.location.href = "checkandpay.html";
                    } catch (error) {
                        alert(error.message);
                        this.innerHTML = 'Next';
                        this.disabled = false;
                    }
                });

                // Back button
                document.querySelector('.btn-back').addEventListener('click', () => window.history.back());

            } catch (error) {
                console.error("Initialization error:", error);
                document.querySelector(".main-card").innerHTML = `
                    <div style="text-align:center;padding:32px;">
                        <div style="color:#e31c23;margin-bottom:16px;">⚠️ ${error.message}</div>
                        <div style="color:#666;margin-bottom:24px;">Please start over from the flight search page.</div>
                        <button onclick="window.location.href='flight-index1.html'" 
                                style="background:#0071c2;color:#fff;border:none;border-radius:7px;padding:10px 32px;font-size:1.1em;font-weight:500;cursor:pointer;">
                            Go to Flight Search
                        </button>
                    </div>`;
            }
        });
    </script>
</body>
</html>
